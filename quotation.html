<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Under 2 Minutes — Quotation</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
        <style>
            .table thead th {
                white-space: nowrap;
            }
            .sidebar {
                min-height: calc(100vh - 76px);
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            }
            .nav-link {
                border-radius: 4px;
                transition: all 0.2s;
                margin: 2px 8px;
            }
            .nav-link:hover {
                background: rgba(255, 255, 255, 0.15);
                transform: translateX(4px);
            }
            .nav-link.active {
                background: rgba(255, 255, 255, 0.25);
                font-weight: 500;
            }
            @media (max-width: 768px) {
                .sidebar {
                    min-height: auto;
                    position: sticky;
                    top: 76px;
                    z-index: 1000;
                }
                .nav {
                    flex-direction: row;
                    overflow-x: auto;
                }
                .nav-item {
                    min-width: 160px;
                }
            }
        </style>
    </head>
    <body class="bg-light">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                    <i class="bi bi-lightning-charge-fill"></i>
                    <span>Under 2 Minutes</span>
                </a>

                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarContent"
                    aria-controls="navbarContent"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarContent">
                    <form class="ms-auto d-flex" role="search">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input
                                class="form-control"
                                type="search"
                                placeholder="Cari SKU / PO / Quotation / Invoice"
                                aria-label="Search"
                            />
                        </div>
                    </form>
                    <ul class="navbar-nav ms-3 mb-2 mb-lg-0 align-items-lg-center">
                        <li class="nav-item me-lg-2">
                            <a class="nav-link" href="#" onclick="refreshDemo()" title="Refresh data demo"
                                ><i class="bi bi-arrow-clockwise"></i
                            ></a>
                        </li>
                        <li class="nav-item dropdown">
                            <a
                                class="nav-link dropdown-toggle d-flex align-items-center"
                                href="#"
                                id="userMenu"
                                role="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                <i class="bi bi-person-circle me-2"></i>
                                <span id="userName">Customer</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                                <li><h6 class="dropdown-header" id="userEmail">you@company.com</h6></li>
                                <li>
                                    <a class="dropdown-item" href="quotation.html"
                                        ><i class="bi bi-file-earmark-text me-2"></i>Quotations</a
                                    >
                                </li>
                                <li>
                                    <a class="dropdown-item" href="po.html"
                                        ><i class="bi bi-upload me-2"></i>Upload PO</a
                                    >
                                </li>
                                <li>
                                    <a class="dropdown-item" href="orders.html"
                                        ><i class="bi bi-clipboard-check me-2"></i>Orders</a
                                    >
                                </li>
                                <li>
                                    <a class="dropdown-item" href="receive.html"
                                        ><i class="bi bi-check-circle me-2"></i>Confirm Delivery</a
                                    >
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" onclick="logout()"
                                        ><i class="bi bi-box-arrow-right me-2"></i>Logout</a
                                    >
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <main class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3 col-lg-2 bg-primary sidebar">
                    <div class="sidebar-sticky pt-3">
                        <h5 class="px-3 text-white mb-3">Main Navigation</h5>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link text-white" href="dashboard.html">
                                    <i class="bi bi-house-door me-2"></i>
                                    Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="quotation.html">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    Quotations
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="po.html">
                                    <i class="bi bi-upload me-2"></i>
                                    Upload PO
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="orders.html">
                                    <i class="bi bi-clipboard-check me-2"></i>
                                    Orders/SPK Internal
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="tracking-customer.html">
                                    <i class="bi bi-truck me-2"></i>
                                    Tracking
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="receive.html">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Confirm Delivery
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="invoices.html">
                                    <i class="bi bi-receipt me-2"></i>
                                    Invoices
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Main content -->
                <div class="col-md-9 col-lg-10 p-4">
                    <div class="mb-2">
                        <h1 class="h4 mb-0"><i class="bi bi-file-earmark-text me-2"></i>Quotation</h1>
                        <div class="text-secondary">
                            Buat penawaran multi-item. Subtotal, PPN 11%, dan Grand Total dihitung otomatis.
                        </div>
                    </div>
                    <!-- Form Tambah Item -->
                    <div class="card mb-4 shadow-sm border-0">
                        <div class="card-header bg-white"><strong>Tambah Item Produk</strong></div>
                        <div class="card-body">
                            <form id="itemForm" class="row g-3">
                                <div class="col-md-5">
                                    <label class="form-label">Produk</label>
                                    <select id="product" class="form-select" required>
                                        <option value="">-- Pilih Produk --</option>
                                        <option value="Lakban 100 meter" data-price="5000">
                                            Lakban 100 meter - 5.000
                                        </option>
                                        <option value="Lakban 500 meter" data-price="10000">
                                            Lakban 500 meter - 10.000
                                        </option>
                                        <option value="Lakban 1000 meter" data-price="15000">
                                            Lakban 1000 meter - 15.000
                                        </option>
                                        <option value="Mesin A" data-price="1000000">Mesin A — Rp 1.000.000</option>
                                        <option value="Mesin B" data-price="1500000">Mesin B — Rp 1.500.000</option>
                                        <option value="Mesin C" data-price="2000000">Mesin C — Rp 2.000.000</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Qty</label>
                                    <input type="number" id="qty" class="form-control" min="1" value="1" required />
                                </div>
                                <div class="col-md-4 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-cart-plus"></i> Tambah Item
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Tabel Item & Summary -->
                    <div class="card mb-4 shadow-sm border-0">
                        <div class="card-header bg-white"><strong>Item dalam Quotation</strong></div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="min-width: 220px">Produk</th>
                                            <th class="text-end" style="width: 120px">Qty</th>
                                            <th class="text-end" style="width: 160px">Harga</th>
                                            <th class="text-end" style="width: 180px">Total</th>
                                            <th class="text-center" style="width: 80px">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemTable"></tbody>
                                </table>
                            </div>

                            <div class="row g-3 justify-content-end">
                                <div class="col-md-6 col-lg-4">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Subtotal</span><strong id="subtotal">Rp 0</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>PPN 11%</span><strong id="ppn">Rp 0</strong>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Grand Total</span><strong id="grandtotal">Rp 0</strong>
                                        </li>
                                    </ul>
                                    <div class="text-end mt-3">
                                        <button class="btn btn-success" id="saveBtn" onclick="saveQuotation()" disabled>
                                            <i class="bi bi-save"></i> Simpan Quotation
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daftar Quotation -->
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <strong>Daftar Quotation</strong>
                            <small class="text-secondary">Klik printer untuk unduh PDF</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 160px">No. Quotation</th>
                                            <th>Tanggal</th>
                                            <th>Jumlah Item</th>
                                            <th class="text-end">Grand Total</th>
                                            <th>Status</th>
                                            <th class="text-end" style="width: 160px">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="quotationTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- libs -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
        <script>
            // Route guard: must be logged in
            const auth = JSON.parse(localStorage.getItem("u2m_auth") || "null");
            if (!auth) window.location.href = "index.html";
            // ===== Utils =====
            function formatCurrency(n) {
                return new Intl.NumberFormat("id-ID", {
                    style: "currency",
                    currency: "IDR",
                    maximumFractionDigits: 0,
                }).format(n || 0);
            }
            function todayStr() {
                return new Date().toISOString().slice(0, 10);
            }

            document.getElementById("userName").textContent = auth?.name || "Customer";
            document.getElementById("userEmail").textContent = auth?.email || "";

            // ===== State =====
            let currentItems = [];
            let quotations = JSON.parse(localStorage.getItem("u2m_quotations") || "[]");

            const itemForm = document.getElementById("itemForm");
            const itemTable = document.getElementById("itemTable");
            const subtotalEl = document.getElementById("subtotal");
            const ppnEl = document.getElementById("ppn");
            const grandEl = document.getElementById("grandtotal");
            const saveBtn = document.getElementById("saveBtn");
            const quotationTable = document.getElementById("quotationTable");

            // ===== Add item =====
            itemForm.addEventListener("submit", function (e) {
                e.preventDefault();
                const pSel = document.getElementById("product");
                const qtyInput = document.getElementById("qty");
                const name = pSel.value;
                const price = parseInt(pSel.selectedOptions[0]?.dataset.price || 0, 10);
                const qty = parseInt(qtyInput.value || "0", 10);
                if (!name || qty < 1) return;
                const total = price * qty;
                currentItems.push({ product: name, price, qty, total });
                renderItems();
                itemForm.reset();
                qtyInput.value = 1;
            });

            function renderItems() {
                itemTable.innerHTML = "";
                let subtotal = 0;
                currentItems.forEach((it, idx) => {
                    subtotal += it.total;
                    itemTable.insertAdjacentHTML(
                        "beforeend",
                        `
                            <tr>
                                <td>${it.product}</td>
                                <td class="text-end">${it.qty}</td>
                                <td class="text-end">${formatCurrency(it.price)}</td>
                                <td class="text-end">${formatCurrency(it.total)}</td>
                                <td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="removeItem(${idx})"><i class="bi bi-trash"></i></button></td>
                            </tr>`
                    );
                });
                const ppn = subtotal * 0.11;
                const grand = subtotal + ppn;
                subtotalEl.textContent = formatCurrency(subtotal);
                ppnEl.textContent = formatCurrency(ppn);
                grandEl.textContent = formatCurrency(grand);
                saveBtn.disabled = currentItems.length === 0;
            }

            function removeItem(i) {
                currentItems.splice(i, 1);
                renderItems();
            }

            // ===== Save quotation =====
            function nextQuoteNumber() {
                // Simple incremental based on existing count
                const n = quotations.length + 1;
                return `Q-${new Date().getFullYear()}-${String(n).padStart(4, "0")}`;
            }

            function saveQuotation() {
                const subtotal = currentItems.reduce((s, it) => s + it.total, 0);
                const ppn = subtotal * 0.11;
                const grandtotal = subtotal + ppn;
                const q = {
                    id: nextQuoteNumber(),
                    date: todayStr(),
                    items: [...currentItems],
                    subtotal,
                    ppn,
                    grandtotal,
                    status: "DRAFT",
                    customer: { name: auth?.name || "Customer", email: auth?.email || "" },
                };
                quotations.push(q);
                localStorage.setItem("u2m_quotations", JSON.stringify(quotations));
                currentItems = [];
                renderItems();
                renderQuotations();
            }

            // ===== Render quotations list =====
            function badge(status) {
                const map = { DRAFT: "secondary", APPROVED: "success", REJECTED: "danger" };
                return `<span class="badge text-bg-${map[status] || "secondary"}">${status}</span>`;
            }

            function renderQuotations() {
                quotationTable.innerHTML = "";
                quotations.forEach((q, index) => {
                    quotationTable.insertAdjacentHTML(
                        "beforeend",
                        `
                            <tr>
                                <td class="fw-medium">${q.id}</td>
                                <td>${q.date}</td>
                                <td>${q.items.length} item</td>
                                <td class="text-end">${formatCurrency(q.grandtotal)}</td>
                                <td>${badge(q.status)}</td>
                                <td class="text-end">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-success" title="Setujui" onclick="approveQuotation(${index})"><i class="bi bi-check-circle"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" title="Tolak" onclick="rejectQuotation(${index})"><i class="bi bi-x-circle"></i></button>
                                    <button class="btn btn-sm btn-primary" title="Print PDF" onclick="printQuotation(${index})"><i class="bi bi-printer"></i></button>
                                </div>
                                </td>
                            </tr>`
                    );
                });
            }

            function approveQuotation(index) {
                quotations[index].status = "APPROVED";
                localStorage.setItem("u2m_quotations", JSON.stringify(quotations));
                renderQuotations();
            }
            function rejectQuotation(i) {
                quotations[i].status = "REJECTED";
                persist();
                renderQuotations();
            }
            function persist() {
                localStorage.setItem("u2m_quotations", JSON.stringify(quotations));
            }

            function syncPOs() {
                const approved = quotations.filter((q) => q.status === "APPROVED");
                let pos = JSON.parse(localStorage.getItem("u2m_pos") || "[]");

                approved.forEach((q) => {
                    if (!pos.find((p) => p.id === q.id)) {
                        pos.push({
                            id: q.id,
                            quotationNumber: q.id,
                            poNumber: `PO-${q.id}`,
                            poDate: todayStr(),
                            fileName: "", // default kosong
                            date: todayStr(),
                            status: "APPROVED",
                        });
                    }
                });

                localStorage.setItem("u2m_pos", JSON.stringify(pos));
            }

            // ===== Print to PDF (jsPDF + autoTable) =====
            function printQuotation(index) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const q = quotations[index];

                // Header
                doc.setFontSize(16);
                doc.text("QUOTATION", 105, 14, { align: "center" });
                doc.setFontSize(11);
                doc.text("Under 2 Minutes — Customer Portal", 105, 20, { align: "center" });

                // Meta
                doc.setFontSize(10);
                doc.text(`No: ${q.id}`, 14, 32);
                doc.text(`Tanggal: ${q.date}`, 14, 38);
                doc.text(`Customer: ${q.customer?.name || ""}`, 120, 32);
                doc.text(`Email: ${q.customer?.email || ""}`, 120, 38);

                // Table
                const body = q.items.map((it, i) => [
                    i + 1,
                    it.product,
                    it.qty,
                    formatCurrency(it.price),
                    formatCurrency(it.total),
                ]);
                doc.autoTable({
                    startY: 46,
                    head: [["No", "Nama Barang", "Qty", "Harga", "Subtotal"]],
                    body,
                });

                // Totals
                const y = doc.lastAutoTable.finalY + 8;
                doc.text(`Subtotal: ${formatCurrency(q.subtotal)}`, 130, y);
                doc.text(`PPN (11%): ${formatCurrency(q.ppn)}`, 130, y + 6);
                doc.setFontSize(12);
                doc.text(`Grand Total: ${formatCurrency(q.grandtotal)}`, 130, y + 12);

                // Footer note
                doc.setFontSize(9);
                doc.text("Masa berlaku penawaran 14 hari kalender sejak tanggal terbit.", 14, y + 20);

                doc.save(`${q.id}.pdf`);
            }

            // Add active class to current page in sidebar
            document.querySelectorAll(".nav-link").forEach((link) => {
                if (link.href === window.location.href) {
                    link.classList.add("active");
                }
            });

            function logout() {
                localStorage.removeItem("u2m_auth");
                window.location.href = "index.html";
            }

            // Init
            renderItems();
            renderQuotations();
        </script>
    </body>
</html>
