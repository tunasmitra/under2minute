<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Under 2 Minutes â€” Dashboard</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
        <style>
            .stat-card i {
                opacity: 0.9;
            }
            .stat-card .card-body {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            .stat-value {
                font-size: 1.5rem;
                font-weight: 700;
            }
            .click-card {
                cursor: pointer;
                transition: transform 0.08s ease-in-out;
            }
            .click-card:hover {
                transform: translateY(-2px);
            }
            .table thead th {
                white-space: nowrap;
            }
            .sidebar {
                min-height: calc(100vh - 76px);
                box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            }
            .nav-link {
                border-radius: 4px;
                transition: all 0.2s;
                margin: 2px 8px;
            }
            .nav-link:hover {
                background: rgba(255, 255, 255, 0.15);
                transform: translateX(4px);
            }
            .nav-link.active {
                background: rgba(255, 255, 255, 0.25);
                font-weight: 500;
            }
            @media (max-width: 768px) {
                .sidebar {
                    min-height: auto;
                    position: sticky;
                    top: 76px;
                    z-index: 1000;
                }
                .nav {
                    flex-direction: row;
                    overflow-x: auto;
                }
                .nav-item {
                    min-width: 160px;
                }
            }
        </style>
    </head>
    <body class="bg-light">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                    <i class="bi bi-lightning-charge-fill"></i>
                    <span>Under 2 Minutes</span>
                </a>

                <button
                    class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarContent"
                    aria-controls="navbarContent"
                    aria-expanded="false"
                    aria-label="Toggle navigation"
                >
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarContent">
                    <form class="ms-auto d-flex" role="search">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input
                                class="form-control"
                                type="search"
                                placeholder="Cari SKU / PO / Quotation / Invoice"
                                aria-label="Search"
                            />
                        </div>
                    </form>
                    <ul class="navbar-nav ms-3 mb-2 mb-lg-0 align-items-lg-center">
                        <li class="nav-item me-lg-2">
                            <a class="nav-link" href="#" onclick="refreshDemo()" title="Refresh data demo"
                                ><i class="bi bi-arrow-clockwise"></i
                            ></a>
                        </li>
                        <li class="nav-item dropdown">
                            <a
                                class="nav-link dropdown-toggle d-flex align-items-center"
                                href="#"
                                id="userMenu"
                                role="button"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                <i class="bi bi-person-circle me-2"></i>
                                <span id="userName">Customer</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                                <li><h6 class="dropdown-header" id="userEmail">you@company.com</h6></li>
                                <li>
                                    <a class="dropdown-item" href="quotation.html"
                                        ><i class="bi bi-file-earmark-text me-2"></i>Quotations</a
                                    >
                                </li>
                                <li>
                                    <a class="dropdown-item" href="po.html"
                                        ><i class="bi bi-upload me-2"></i>Upload PO</a
                                    >
                                </li>
                                <li>
                                    <a class="dropdown-item" href="orders.html"
                                        ><i class="bi bi-clipboard-check me-2"></i>Orders</a
                                    >
                                </li>
                                <li>
                                    <a class="dropdown-item" href="receive.html"
                                        ><i class="bi bi-check-circle me-2"></i>Confirm Delivery</a
                                    >
                                </li>
                                <li><hr class="dropdown-divider" /></li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" onclick="logout()"
                                        ><i class="bi bi-box-arrow-right me-2"></i>Logout</a
                                    >
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <main class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-3 col-lg-2 bg-primary sidebar">
                    <div class="sidebar-sticky pt-3">
                        <h5 class="px-3 text-white mb-3">Main Navigation</h5>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link text-white" href="dashboard.html">
                                    <i class="bi bi-house-door me-2"></i>
                                    Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="quotation.html">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    Quotations
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="po.html">
                                    <i class="bi bi-upload me-2"></i>
                                    Upload PO
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="orders.html">
                                    <i class="bi bi-clipboard-check me-2"></i>
                                    Orders/SPK Internal
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="tracking-customer.html">
                                    <i class="bi bi-truck me-2"></i>
                                    Tracking
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="receive.html">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Confirm Delivery
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-white" href="invoices.html">
                                    <i class="bi bi-receipt me-2"></i>
                                    Invoices
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Main content -->
                <div class="col-md-9 col-lg-10 p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h1 class="h4 mb-0">Dashboard</h1>
                            <div class="text-secondary" id="welcomeLine">Selamat datang ðŸ‘‹</div>
                        </div>
                    </div>

                    <!-- KPI Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-sm-6 col-lg-4 col-xxl-2">
                            <a href="quotation.html">
                                <div class="card stat-card shadow-sm border-0 click-card">
                                    <div class="card-body">
                                        <i class="bi bi-file-earmark-text fs-2 text-primary"></i>
                                        <div>
                                            <div class="text-secondary small">Quotations</div>
                                            <div class="stat-value" id="statQuotes">â€”</div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-sm-6 col-lg-4 col-xxl-2">
                            <div class="card stat-card shadow-sm border-0">
                                <div class="card-body">
                                    <i class="bi bi-clipboard-check fs-2 text-success"></i>
                                    <div>
                                        <div class="text-secondary small">PO</div>
                                        <div class="stat-value" id="statPO">â€”</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4 col-xxl-2">
                            <div class="card stat-card shadow-sm border-0">
                                <div class="card-body">
                                    <i class="bi bi-gear-wide-connected fs-2 text-info"></i>
                                    <div>
                                        <div class="text-secondary small">Diproses</div>
                                        <div class="stat-value" id="statProcess">â€”</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4 col-xxl-2">
                            <div class="card stat-card shadow-sm border-0" onclick="goto('tracking.html')">
                                <div class="card-body">
                                    <i class="bi bi-truck fs-2 text-warning"></i>
                                    <div>
                                        <div class="text-secondary small">Dalam Pengiriman</div>
                                        <div class="stat-value" id="statShipping">â€”</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4 col-xxl-2">
                            <div class="card stat-card shadow-sm border-0" onclick="goto('invoices.html')">
                                <div class="card-body">
                                    <i class="bi bi-receipt fs-2 text-danger"></i>
                                    <div>
                                        <div class="text-secondary small">Tagihan</div>
                                        <div class="stat-value" id="statInvoices">â€”</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-4 col-xxl-2">
                            <div class="card stat-card shadow-sm border-0">
                                <div class="card-body">
                                    <i class="bi bi-check2-circle fs-2 text-secondary"></i>
                                    <div>
                                        <div class="text-secondary small">Selesai</div>
                                        <div class="stat-value" id="statDone">â€”</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <!-- Recent Quotations -->
                        <div class="col-12">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h2 class="h6 mb-0">
                                            <i class="bi bi-file-earmark-text me-2 text-primary"></i>Quotation Terbaru
                                        </h2>
                                        <a class="text-decoration-none" href="quotation.html">Lihat semua</a>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Tanggal</th>
                                                    <th>Customer Site</th>
                                                    <th>Total</th>
                                                    <th>Status</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="tblQuotes"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr />
                        <!-- Invoices -->
                        <div class="col-12">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h2 class="h6 mb-0">
                                            <i class="bi bi-receipt me-2 text-danger"></i>Tagihan (Due Soon)
                                        </h2>
                                        <a class="text-decoration-none" href="invoices.html">Lihat semua</a>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>#</th>
                                                    <th>Tanggal</th>
                                                    <th>Jatuh Tempo</th>
                                                    <th>Total</th>
                                                    <th>Status</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="tblInvoices"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr />
                        <div class="col-12">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h2 class="h6 mb-0">
                                            <i class="bi bi-stack-overflow me-2 text-danger"></i>Simulasi Internal Tunas
                                            Mitra
                                        </h2>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-striped align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>No Order</th>
                                                    <th>No PO</th>
                                                    <th>Quotation</th>
                                                    <th>Tanggal Order</th>
                                                    <th>Deadline</th>
                                                    <th>Status</th>
                                                    <th>Aksi</th>
                                                </tr>
                                            </thead>
                                            <tbody id="trackingTable"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
        <script>
            // Guard: redirect to login if not authenticated
            const auth = JSON.parse(localStorage.getItem("u2m_auth") || "null");
            if (!auth) window.location.href = "login.html";
            // Add active class to current page in sidebar
            document.querySelectorAll(".nav-link").forEach((link) => {
                if (link.href === window.location.href) {
                    link.classList.add("active");
                }
            });

            // Populate user info
            document.getElementById("userName").textContent = auth?.name || "Customer";
            document.getElementById("userEmail").textContent = auth?.email || "";
            document.getElementById("welcomeLine").textContent = `Selamat datang, ${auth?.name || "Customer"} ðŸ‘‹`;
            let quotations = JSON.parse(localStorage.getItem("u2m_quotations") || "[]");

            function logout() {
                localStorage.removeItem("u2m_auth");
                window.location.href = "login.html";
            }
            function formatCurrency(n) {
                return new Intl.NumberFormat("id-ID", {
                    style: "currency",
                    currency: "IDR",
                    maximumFractionDigits: 0,
                }).format(n || 0);
            }
            function goto(page) {
                // Demo: prevent 404 for pages belum dibuat
                if (
                    ![
                        "quotation.html",
                        "po.html",
                        "tracking.html",
                        "invoices.html",
                        "receive.html",
                        "orders.html",
                    ].includes(page)
                )
                    return;
                alert("Demo: Halaman " + page + " belum dibuat.");
            }

            // Demo data generator
            function currency(n) {
                return new Intl.NumberFormat("id-ID", {
                    style: "currency",
                    currency: "IDR",
                    maximumFractionDigits: 0,
                }).format(n);
            }
            function badge(status) {
                const map = {
                    SENT: "primary",
                    ACCEPTED: "success",
                    EXPIRED: "secondary",
                    DRAFT: "warning",
                    DRAFT: "secondary",
                    SENT: "primary",
                    APPROVED: "success",
                    REJECTED: "danger",
                    UNPAID: "danger",
                    PARTIAL: "warning",
                    PAID: "success",
                    "Dalam Proses": "primary",
                    Produksi: "warning",
                    Dikirim: "info",
                    Selesai: "success",
                };
                const color = map[status] || "secondary";
                return `<span class="badge text-bg-${color}">${status}</span>`;
            }

            function render() {
                // Get real data from localStorage
                const quotations = JSON.parse(localStorage.getItem("u2m_quotations") || "[]");
                const pos = JSON.parse(localStorage.getItem("u2m_pos") || "[]");
                const invoices = JSON.parse(localStorage.getItem("u2m_invoices") || "[]");
                const orders = JSON.parse(localStorage.getItem("u2m_orders") || "[]");

                // Calculate KPIs
                const data = {
                    kpis: {
                        quotes: quotations.length,
                        po: pos.filter((p) => p.status === "Menunggu Proses").length,
                        process: orders.filter((o) => o.status === "Dalam Proses").length,
                        ship: orders.filter((o) => o.status === "Dikirim").length,
                        invoices: invoices.filter((i) => i.status === "Belum Dibayar").length,
                        done: orders.filter((o) => o.status === "Selesai").length,
                    },
                    quotes: quotations.slice(0, 4).map((q) => ({
                        id: q.id,
                        date: q.date,
                        site: q.customer?.site || "N/A",
                        total: q.grandtotal,
                        status: q.status,
                    })),
                    invoices: invoices.slice(0, 2).map((i) => ({
                        id: i.invoiceNumber,
                        date: i.date,
                        due: i.dueDate || i.date,
                        total: i.amount,
                        status: i.status === "Lunas" ? "PAID" : "UNPAID",
                    })),
                };
                // KPIs
                document.getElementById("statQuotes").textContent = data.kpis.quotes;
                document.getElementById("statPO").textContent = data.kpis.po;
                document.getElementById("statProcess").textContent = data.kpis.process;
                document.getElementById("statShipping").textContent = data.kpis.ship;
                document.getElementById("statInvoices").textContent = data.kpis.invoices;
                document.getElementById("statDone").textContent = data.kpis.done;

                // Quotes table
                const qtbody = document.getElementById("tblQuotes");
                qtbody.innerHTML = data.quotes
                    .map(
                        (q, index) => `
                            <tr>
                            <td class="fw-medium">${q.id}</td>
                            <td>${q.date}</td>
                            <td>${q.site}</td>
                            <td>${currency(q.total)}</td>
                            <td>${badge(q.status)}</td>
                            <td class="text-end">
                                <a href="quotation.html" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i></a>
                                <button class="btn btn-sm btn-primary" title="Print PDF" onclick="printQuotation(${index})"><i class="bi bi-printer"></i></button>
                            </td>
                            </tr>
                        `
                    )
                    .join("");

                // Invoices table
                const itbody = document.getElementById("tblInvoices");
                itbody.innerHTML = data.invoices
                    .map(
                        (inv) => `
                            <tr>
                            <td class="fw-medium">${inv.id}</td>
                            <td>${inv.date}</td>
                            <td>${inv.due}</td>
                            <td>${currency(inv.total)}</td>
                            <td>${badge(inv.status)}</td>
                            <td class="text-end">
                                <a href="invoices.html" class="btn btn-sm btn-outline-secondary"><i class="bi bi-receipt"></i></a>
                            </td>
                            </tr>
                        `
                    )
                    .join("");
            }

            function refreshDemo() {
                render();
            }

            render();
            // ===== Print to PDF (jsPDF + autoTable) =====
            function printQuotation(index) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const q = quotations[index];

                // Header
                doc.setFontSize(16);
                doc.text("QUOTATION", 105, 14, { align: "center" });
                doc.setFontSize(11);
                doc.text("Under 2 Minutes â€” Customer Portal", 105, 20, { align: "center" });

                // Meta
                doc.setFontSize(10);
                doc.text(`No: ${q.id}`, 14, 32);
                doc.text(`Tanggal: ${q.date}`, 14, 38);
                doc.text(`Customer: ${q.customer?.name || ""}`, 120, 32);
                doc.text(`Email: ${q.customer?.email || ""}`, 120, 38);

                // Table
                const body = q.items.map((it, i) => [
                    i + 1,
                    it.product,
                    it.qty,
                    formatCurrency(it.price),
                    formatCurrency(it.total),
                ]);
                doc.autoTable({
                    startY: 46,
                    head: [["No", "Nama Barang", "Qty", "Harga", "Subtotal"]],
                    body,
                });

                // Totals
                const y = doc.lastAutoTable.finalY + 8;
                doc.text(`Subtotal: ${formatCurrency(q.subtotal)}`, 130, y);
                doc.text(`PPN (11%): ${formatCurrency(q.ppn)}`, 130, y + 6);
                doc.setFontSize(12);
                doc.text(`Grand Total: ${formatCurrency(q.grandtotal)}`, 130, y + 12);

                // Footer note
                doc.setFontSize(9);
                doc.text("Masa berlaku penawaran 14 hari kalender sejak tanggal terbit.", 14, y + 20);

                doc.save(`${q.id}.pdf`);
            }
        </script>
        <script>
            const orders = JSON.parse(localStorage.getItem("u2m_orders")) || [];
            const trackingTable = document.getElementById("trackingTable");

            function renderTracking() {
                trackingTable.innerHTML = "";
                orders.forEach((o, index) => {
                    trackingTable.innerHTML += `
                        <tr>
                            <td>${o.orderNumber}</td>
                            <td>${o.poNumber}</td>
                            <td>${o.quotationNumber}</td>
                            <td>${o.date}</td>
                            <td>${o.deadline}</td>
                            <td><span class="badge bg-${statusColor(o.status)}">${o.status}</span></td>
                            <td>
                            <select class="form-select form-select-sm" onchange="updateStatus(${index}, this.value)">
                                <option value="Dalam Proses" ${
                                    o.status === "Dalam Proses" ? "selected" : ""
                                }>Dalam Proses</option>
                                <option value="Produksi" ${o.status === "Produksi" ? "selected" : ""}>Produksi</option>
                                <option value="Dikirim" ${o.status === "Dikirim" ? "selected" : ""}>Dikirim</option>
                                <option value="Selesai" ${o.status === "Selesai" ? "selected" : ""}>Selesai</option>
                            </select>
                            </td>
                        </tr>
                        `;
                });
            }

            function updateStatus(index, newStatus) {
                orders[index].status = newStatus;
                localStorage.setItem("u2m_orders", JSON.stringify(orders));
                renderTracking();
            }

            function statusColor(status) {
                switch (status) {
                    case "Dalam Proses":
                        return "primary";
                    case "Produksi":
                        return "warning";
                    case "Dikirim":
                        return "info";
                    case "Selesai":
                        return "success";
                    default:
                        return "secondary";
                }
            }

            renderTracking();
        </script>
    </body>
</html>
