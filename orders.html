<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Orders</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    </head>
    <body class="container py-4">
        <h3 class="mb-4">Daftar Orders</h3>

        <!-- Form Tambah Order -->
        <form id="orderForm" class="row g-3 mb-4">
            <div class="col-md-4">
                <label class="form-label">Pilih PO</label>
                <select id="poSelect" class="form-select" required>
                    <option value="">-- Pilih PO --</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">No Order</label>
                <input type="text" id="orderNumber" class="form-control" required placeholder="ORD-2025-0001" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Deadline</label>
                <input type="date" id="deadline" class="form-control" required />
            </div>
            <div class="col-12">
                <label class="form-label">Deskripsi</label>
                <textarea
                    id="description"
                    class="form-control"
                    rows="2"
                    placeholder="Deskripsi order..."
                    required
                ></textarea>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg"></i> Tambah Order</button>
            </div>
        </form>

        <!-- Tabel Orders -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>No Order</th>
                        <th>No PO</th>
                        <th>Quotation</th>
                        <th>Tanggal Order</th>
                        <th>Deadline</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="ordersTable"></tbody>
            </table>
        </div>

        <script>
            const poList = JSON.parse(localStorage.getItem("u2m_pos")) || [];
            const orders = JSON.parse(localStorage.getItem("u2m_orders")) || [];

            const poSelect = document.getElementById("poSelect");
            const ordersTable = document.getElementById("ordersTable");

            // Tampilkan PO yang sudah diupload customer
            poList.forEach((po, idx) => {
                const opt = document.createElement("option");
                opt.value = idx;
                opt.textContent = `${po.poNumber || po.quotationNumber} | ${formatCurrency(po.quotationTotal || 0)}`;
                poSelect.appendChild(opt);
            });

            // Submit Order
            document.getElementById("orderForm").addEventListener("submit", function (e) {
                e.preventDefault();

                const poIndex = poSelect.value;
                const orderNumber = document.getElementById("orderNumber").value.trim();
                const deadline = document.getElementById("deadline").value;
                const description = document.getElementById("description").value.trim();

                if (!poIndex || !orderNumber || !deadline || !description) {
                    alert("Mohon lengkapi semua data!");
                    return;
                }

                const selectedPO = poList[poIndex];

                const orderData = {
                    orderNumber,
                    poNumber: selectedPO.poNumber || selectedPO.quotationNumber,
                    quotationNumber: selectedPO.quotationNumber,
                    description,
                    date: new Date().toLocaleString(),
                    deadline,
                    status: "Dalam Proses",
                };

                orders.push(orderData);
                localStorage.setItem("u2m_orders", JSON.stringify(orders));

                this.reset();
                renderOrders();
            });

            function renderOrders() {
                ordersTable.innerHTML = "";
                orders.forEach((o) => {
                    ordersTable.innerHTML += `
          <tr>
            <td>${o.orderNumber}</td>
            <td>${o.poNumber}</td>
            <td>${o.quotationNumber}</td>
            <td>${o.date}</td>
            <td>${o.deadline}</td>
            <td><span class="badge bg-primary">${o.status}</span></td>
          </tr>
        `;
                });
            }

            function formatCurrency(value) {
                return new Intl.NumberFormat("id-ID", {
                    style: "currency",
                    currency: "IDR",
                    minimumFractionDigits: 0,
                }).format(value);
            }

            renderOrders();
        </script>
    </body>
</html>
